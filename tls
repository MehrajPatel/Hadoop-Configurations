________________________________________________________________
_________________________Cert Generation________________________
----------------------------------------------------------------

				--------------------------------
						On Server Only
				--------------------------------
				
sudo mkdir -p /opt/cloudera/security/x509/ /opt/cloudera/security/jks/
sudo chown -R cloudera-scm:cloudera-scm /opt/cloudera/security/jks 
sudo chown -R cloudera-scm:cloudera-scm /opt/cloudera/security/x509
sudo umask 0700
cd /opt/cloudera/security/jks

#generate keypair 

sudo -u cloudera-scm $JAVA_HOME/bin/keytool \
-genkeypair \
-alias `hostname -f` \
-keyalg RSA \
-keystore /opt/cloudera/security/jks/`hostname -f`.jks \
-keysize 2048 \
-dname "CN=`hostname -f`,OU=Engineering,O=Cloudera,L=Palo Alto,ST=California,C=US" \
-ext san=dns:`hostname -f` \
-keypass P@ssw0rd \
-storepass P@ssw0rd

ln -s /opt/cloudera/security/jks/`hostname -f`.jks /opt/cloudera/security/jks/server.jks



sudo -u cloudera-scm $JAVA_HOME/bin/keytool \
-export \
-alias `hostname -f` \
-keystore /opt/cloudera/security/jks/server.jks \
-rfc \
-file /tmp/selfsigned.cer

cp /tmp/selfsigned.cer /opt/cloudera/security/x509/cloudera.pem

scp selfsigned.cer and and /opt/cloudera/security/x509/cloudera.pem to all the hosts and perform following operations on all the hosts(server + agents)

				--------------------------------
						On All Hosts
				--------------------------------
				
sudo cp $JAVA_HOME/jre/lib/security/cacerts $JAVA_HOME/jre/lib/security/jssecacerts

#import cert to truststore
sudo $JAVA_HOME/bin/keytool \
-import \
-alias `hostname -f` \
-file /opt/cloudera/security/jks/selfsigned.cer \
-storepass changeit \
-storetype JKS \
-keystore $JAVA_HOME/jre/lib/security/jssecacerts

chown cloudera-scm:cloudera-scm $JAVA_HOME/jre/lib/security/jssecacerts
chmod 777 $JAVA_HOME/jre/lib/security/jssecacerts

________________________________________________________________
__________________Configuration Changes on CM___________________
----------------------------------------------------------------


goto Administration > Settings > Security 

Property													Description
Cloudera Manager TLS/SSL Server JKS Keystore File Location	/opt/cloudera/security/jks/server.jks
Cloudera Manager TLS/SSL Server JKS Keystore File Password	P@ssw0rd
Use TLS Encryption for Admin Console						Checked

go to the Cloudera Management Service service Configuration > Cloudera Management Service (Service-Wide) > Security.

Property											Description
TLS/SSL Client Truststore File Location				$JAVA_HOME/jre/lib/security/jssecacerts (replace $JAVA_HOME with absolute path)
Cloudera Manager Server TLS/SSL Certificate 		changeit
Trust Store Password

#Restart Cloudera Manager and Services
sudo systemctl restart cloudera-scm-server

#Result of following command should be OK
openssl s_client -connect 54.190.7.82:7183 -CAfile /opt/cloudera/security/x509/cloudera.pem

________________________________________________________________
_____________Configure TLS for Cloudera Manager Agents__________
----------------------------------------------------------------

Administration > Settings > Security category > Use TLS Encryption for Agents option.

#change use_tls property in /etc/cloudera-scm-agent/config.ini as follows

use_tls=1

sudo systemctl restart cloudera-scm-server
sudo systemctl restart cloudera-scm-agent

_____________________________________________________________________________
______Enable Server Certificate Verification on Cloudera Manager Agents______
-----------------------------------------------------------------------------
#change verify_cert_file property in /etc/cloudera-scm-agent/config.ini as follows

verify_cert_file=/opt/cloudera/security/x509/cloudera.pem

sudo systemctl restart cloudera-scm-agent

_____________________________________________________________________________
_________________Configure Agent Certificate Authentication__________________
-----------------------------------------------------------------------------
				--------------------------------
						On All Hosts Only
				--------------------------------

configure /etc/hosts file

sudo -u cloudera-scm $JAVA_HOME/bin/keytool \
-genkeypair \
-alias `hostname -f` \
-keyalg RSA \
-keystore /opt/cloudera/security/jks/`hostname -f`.jks \
-keysize 2048 \
-dname "CN=`hostname -f`,OU=Engineering,O=Cloudera,L=Palo Alto,ST=California,C=US" \
-ext san=dns:`hostname -f` \
-keypass P@ssw0rd \
-storepass P@ssw0rd

sudo -u cloudera-scm $JAVA_HOME/bin/keytool \
-export \
-alias `hostname -f` \
-keystore /opt/cloudera/security/jks/`hostname -f`.jks \
-rfc \
-file /tmp/selfsigned.cer

sudo -u cloudera-scm cp /tmp/selfsigned.cer /opt/cloudera/security/x509/agent.pem

sudo -u cloudera-scm $JAVA_HOME/bin/keytool \
-importkeystore \
-srckeystore /opt/cloudera/security/jks/`hostname -f`.jks \
-destkeystore /opt/cloudera/security/jks/`hostname -f`-key.p12 \
-deststoretype PKCS12 \
-srcalias `hostname -f`

sudo -u cloudera-scm  openssl pkcs12 \
-in /opt/cloudera/security/jks/`hostname -f`-key.p12 \
-nocerts \
-out /opt/cloudera/security/jks/`hostname -f`.key

sudo ln -s /opt/cloudera/security/jks/`hostname -f`.key /opt/cloudera/security/jks/agent.key

sudo su - root -c "echo 'P@ssw0rd' > /etc/cloudera-scm-agent/agentkey.pw"
sudo chown root:root /etc/cloudera-scm-agent/agentkey.pw
sudo chmod 440 /etc/cloudera-scm-agent/agentkey.pw

#change client_key_file,client_keypw_file,client_cert_file properties in /etc/cloudera-scm-agent/config.ini as follows

client_key_file		/opt/cloudera/security/jks/agent.key	
client_keypw_file	/etc/cloudera-scm-agent/agentkey.pw	
client_cert_file	/opt/cloudera/security/x509/agent.pem

----------------------------------------------------------------------------------------------------

Administration > Settings > Security

Setting													   Description
Use TLS Authentication of Agents to Server					Checked
Cloudera Manager TLS/SSL Certificate Trust Store File		$JAVA_HOME/jre/lib/security/jssecacerts (replace $JAVA_HOME with absolute path)
Cloudera Manager TLS/SSL Certificate Trust Store Password	changeit

#restart cloudera manager server and all hosts

sudo systemctl restart cloudera-scm-server


for i in `cat hosts`
do 
ssh $i -q "sudo systemctl status cloudera-scm-agent"
done
